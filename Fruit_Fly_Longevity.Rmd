---
title: "Fruit Fly Longevity"
author: Fiona McLean
output: html_document
bibliography: mybib.bib
header-includes:
  - \usepackage[table,xcdraw]{xcolor}
  - \usepackage{subcaption}
  - \usepackage{float}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
data('fruitfly', package='faraway')

```

##Summary

One hundred twenty-five fruit flies were divided randomly into five groups of 25 each to better understand what effects longevity in fruit flies. One group was kept solitary, while another was kept individually with a virgin female each day. Another group was given eight virgin females per day. As an additional control the fourth and fifth groups were kept with one or eight pregnant females per day (pregnant fruit flies will not mate). The thorax length of each male was measured as this was known to affect lifetime. It was determined that flies who are sexually active have a significant decrease in longevity. Male fruit flies kept with eight virgin females have the lowest longevity compared to isolated flies. Flies kept with one virgin female have a higher longevity compared to the flies kept with eight virgins, but still have a statistically significant lower expected lifespan than isolated flies. There does not appear to be an affect on longevity for flies kept with pregnant females. Thorax length was also found to be a significant indicator of longevity. Flies with a longer thorax live longer in general.   

## The Analysis

The graph below suggests that longevity may be effected by thorax length and sexual activity. It appears that shorter thorax length results in earlier death. It also appears that the mean longevity is shorter than average for flies in the high and low sexual activity group.

```{r, fig.cap= "The graph above shows the longevity of fruit flies in each sexual category, as well as their respective thorax length. The yellow dot refers to the mean longevity in the group.", echo=FALSE, fig.align='center',fig.pos='H', out.width="80%", out.height="80%"}
library(ggplot2)
ggplot(fruitfly, aes(x = activity, y = longevity)) + geom_point(aes(colour = thorax))  +
  stat_summary(fun.y = mean,
               geom = "point",
               shape = 18,
               size = 3.5,
               color="yellow") +
  xlab("Sexually Active") +
  ylab("Longevity (days)") + ggtitle("Longevity of Fruit Fly Compared to Sexual Activity and Thorax Length")

```

A gamma generalized linear model was used to model the lifetimes as a function of thorax length and sexual activity, to determine what factors have a statistically significant effect on lifetime of a fruit fly. Thorax length was centered around the mean to improve interpretability of the model. The baseline for sexual activity was set to isolated.

We first determine if a gamma model is appropriate for modelling the data. We do so by observing how well the gamma distribution fits the fruit fly data.

```{r, include=FALSE}
#------------------QUESTION 1-------------------------------
# Gamma: a gamma distribution for positive continuous data, lifetime in days is positive and continuous

fruitfly$thoraxC <- fruitfly$thorax - mean(fruitfly$thorax)
fruitfly$thoraxC1 <-fruitfly$thoraxC/ sd(fruitfly$thoraxC)

lifetime_model <- glm(longevity ~ thoraxC1 + activity, family=Gamma(link= "log"), data=fruitfly)

```

```{r, fig.cap= "The graphs below are used to determine if the Gamma model is appropriate for the data. The bar chart is the distribution of the data in each sexual activtiy category, and the red line is the corresponding gamma distribution.", echo=FALSE, fig.align='center',fig.pos='H'}
par(mfrow=c(2,3))

shape = 1/summary(lifetime_model)$dispersion
hist(fruitfly[fruitfly$activity == 'low','longevity'], prob=TRUE,
     xlab='low', main = "Low Activity Dist.")
xSeq = seq(par('usr')[1], par('usr')[2], len=200)
lines(xSeq, 
      dgamma(xSeq, shape=shape, 
             scale = exp(lifetime_model$coef['(Intercept)'])/shape), #baseline intercept divided by shape
      col='red', lwd=2
)

shape = 1/summary(lifetime_model)$dispersion
hist(fruitfly[fruitfly$activity == 'high','longevity'], prob=TRUE,
     xlab='high', main = "High Activity Dist.")
xSeq = seq(par('usr')[1], par('usr')[2], len=200)
lines(xSeq, 
      dgamma(xSeq, shape=shape, 
             scale = exp(lifetime_model$coef['(Intercept)'])/shape), #baseline intercept divided by shape
      col='red', lwd=2
)

shape = 1/summary(lifetime_model)$dispersion
hist(fruitfly[fruitfly$activity == 'isolated','longevity'], prob=TRUE,
     xlab='isolated', main = "Isolated Activity Dist.")
xSeq = seq(par('usr')[1], par('usr')[2], len=200)
lines(xSeq, 
      dgamma(xSeq, shape=shape, 
             scale = exp(lifetime_model$coef['(Intercept)'])/shape), #baseline intercept divided by shape
      col='red', lwd=2
)

shape = 1/summary(lifetime_model)$dispersion
hist(fruitfly[fruitfly$activity == 'one','longevity'], prob=TRUE,
     xlab='one', main = "One Activity Dist.")
xSeq = seq(par('usr')[1], par('usr')[2], len=200)
lines(xSeq, 
      dgamma(xSeq, shape=shape, 
             scale = exp(lifetime_model$coef['(Intercept)'])/shape), #baseline intercept divided by shape
      col='red', lwd=2
)

shape = 1/summary(lifetime_model)$dispersion
hist(fruitfly[fruitfly$activity == 'many','longevity'], prob=TRUE,
     xlab='many', main = "Many Activity Dist.")
xSeq = seq(par('usr')[1], par('usr')[2], len=200)
lines(xSeq, 
      dgamma(xSeq, shape=shape, 
             scale = exp(lifetime_model$coef['(Intercept)'])/shape), #baseline intercept divided by shape
      col='red', lwd=2
)

```
Based on the graphs above, the gamma distribution does not appear to fit the data properly. However, we will proceed with the gamma distribution regardless. 

The gamma distribution is:

$Y \sim \Gamma(\frac{u_{i}}{v},v)$ , where:   
   
- $u_{i}$ is expected lifetime
- $v$ is the shape parameter, at a value of 28.15  

Leading to the model:
$\log(u_{i})=\beta_{0}+\beta_{1}(thorax)+\beta_{2}I_{activity \space one}+ \beta_{3}I_{activity \space low}+\beta_{4}I_{activity \space many}+\beta_{5}I_{activity \space high}$

The gamma model examines the effect of thorax length and activity on the longevity of a fruit fly. Interactions were not included in the model as it is unlikely that sexual activity is effected by thorax length or vice verse. The addition of interaction terms were also found to not be statistically significant. 

##Results 

The output for the gamma model is seen in Table \ref{tab:gamma}. Thorax length, High Activity (fly being kept with 8 virgin fruit flies), and Low Activity (fly being kept with one virgin fruit fly) were found to be statistically significant at the 5% level. A fly in a high or low sexual activity category is expected to have a statistically significant lower expected lifetime than an isolated fly. Thorax length positively effects lifetime. That is, flies with longer thorax's tend to live longer. 

Specifically, a one standard deviation increase in thorax length leads to a 22.67% increase in lifespan in isolated flies. An activity low fly at the mean thorax length has a 10.99% decrease in lifespan compared to an isolated fly at the mean thorax length. An activity high fly at the mean thorax length has a 33.94% decrease in expected lifespan compared to an isolated fly at the mean thorax length. The intercept can be interpreted as the expected lifetime of an isolated fly at the mean thorax length is 60.20 days.      

The other coefficients are not interpreted, as they are not significant.

```{r, include=FALSE}
lifetime_model <- glm(longevity ~ thoraxC1 + activity, family=Gamma(link= "log"), data=fruitfly)
table5 <- summary(lifetime_model)$coef
conf_int5 <- confint(lifetime_model)
table5<- cbind(table5, conf_int5)
```



\begin{table}[H]
\centering
```{r, echo=FALSE}
knitr::kable(table5, digits=3, format='latex')
```
\caption{The table above is the output from a gamma regression on the fruit fly data.}
\label{tab:gamma}
\end{table}

